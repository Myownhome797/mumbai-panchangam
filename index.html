<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Time Based Lookup</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .box { border: 1px solid #ccc; padding: 15px; margin-top: 10px; }
</style>
</head>
<body>

<h2>Yes My PANCHAANGAM</h2>
<div id="output" class="box">Loadingâ€¦</div>

<script>
const THITHI_MAPPING = {
        "PRA": "Prathama",
        "DWI": "Dwitheeya",
        "TRU": "Trutheeya",
        "CHA": "Chathurthi",
        "PAN": "Panchami",
        "SHA": "Shashthi",
        "SAP": "Sapthami",
        "ASH": "Ashtami",
        "NAV": "Navami",
        "DAS": "Dashami",
        "EKA": "Ekadashi",
        "DWA": "Dwadashi",
        "TRY": "Trayodashi",
        "CHD": "Chathurdashi",
        "POU": "Pournamaasi",
        "AMA": "Amaavaasya"
      };
  async function loadData() {
  const nowLocal = new Date();
  const nowLocal = new Date();
  nowLocal.setSeconds(0, 0); // seconds = 0, milliseconds = 0

  document.getElementById("output").innerHTML = `
  <b>Current local date & time:</b><br>
  ${nowLocal.toLocaleString(undefined, {
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true
  })}<br>
`
;
;
  const response = await fetch("data_thithi.csv");
  const text = await response.text();

  const lines = text.trim().split("\n");

  // ---- PARSE HEADER ----
  const headers = lines[0].split(",");
  const idx = name => headers.indexOf(name);

  // ---- DATA ROWS ----
  const rows = lines.slice(1);

  // Current time in UTC (ms since epoch)
  const nowUTC = Date.now();

  for (const row of rows) {
    const cols = row.split(",");

    // ---- FROM (UTC) ----
    const fromUTC = Date.parse(
      `${cols[idx("from_date")].slice(0,4)}-${cols[idx("from_date")].slice(4,6)}-${cols[idx("from_date")].slice(6,8)}T` +
      `${cols[idx("from_hh")].padStart(2,"0")}:${cols[idx("from_mm")].padStart(2,"0")}:00Z`
    );

    // ---- TO (UTC) ----
    const toUTC = Date.parse(
      `${cols[idx("to_date")].slice(0,4)}-${cols[idx("to_date")].slice(4,6)}-${cols[idx("to_date")].slice(6,8)}T` +
      `${cols[idx("to_hh")].padStart(2,"0")}:${cols[idx("to_mm")].padStart(2,"0")}:00Z`
    );

    // ---- MATCH CHECK ----
    if (nowUTC >= fromUTC && nowUTC <= toUTC) {
      const fromLocal = new Date(fromUTC);
      const toLocal   = new Date(toUTC);
      const thithiCode = cols[idx("Thithi_1")];
      const thithiDesc = THITHI_MAPPING[thithiCode] ?? thithiCode;
      // ---- TIME CALCULATIONS ----
      const elapsedMs = nowUTC - fromUTC;
      const remainingMs = toUTC - nowUTC;
      
      const elapsedHours = Math.floor(elapsedMs / (1000 * 60 * 60));
      const elapsedMinutes = Math.floor(
        (elapsedMs % (1000 * 60 * 60)) / (1000 * 60)
      );
      
      const remainingHours = Math.floor(remainingMs / (1000 * 60 * 60));
      const remainingMinutes = Math.floor(
        (remainingMs % (1000 * 60 * 60)) / (1000 * 60)
      );


    
document.getElementById("output").innerHTML += `
<br><b>Thithi details:</b><br>
Thithi: ${thithiDesc}<br>
<!-- Thithi: ${cols[idx("Thithi_1")]}<br> -->
Thithi starts at: ${fromLocal.toLocaleString()}<br>
Thithi ends at: ${toLocal.toLocaleString()}<br>
Time elapsed: ${elapsedHours} h ${elapsedMinutes} min<br>
Time remaining: ${remainingHours} h ${remainingMinutes} min<br><br>

<!-- Debug info below -->
<!-- fromUTC: ${fromUTC} -->
<!-- toUTC: ${toUTC} -->
<!-- nowUTC: ${nowUTC} -->
<!-- Thithi_0: ${cols[idx("Thithi_0")]}<br> -->
<!-- Varsham: ${cols[idx("Varsham")]}<br> -->
<!-- Ruthu: ${cols[idx("Ruthu")]}<br> -->
<!-- Chandramanam_masam: ${cols[idx("Chandramanam_masam")]}<br> -->
<!-- Paksham: ${cols[idx("Paksham")]}<br> -->

<!-- from_date: ${cols[idx("from_date")]}<br> -->
<!-- from_hh: ${cols[idx("from_hh")]}<br> -->
<!-- from_mm: ${cols[idx("from_mm")]}<br> -->
<!-- to_date: ${cols[idx("to_date")]}<br> -->
<!-- to_hh: ${cols[idx("to_hh")]}<br> -->
<!-- to_mm: ${cols[idx("to_mm")]}<br> -->
<!-- Duration_in_mins: ${cols[idx("Duration_in_mins")]} -->
`;
      return; // stop after first match
    }
  }


  // runs only if no row matched
  document.getElementById("output").innerHTML =
    "No matching record for current time.";
}

loadData();
</script>


</body>
</html>
